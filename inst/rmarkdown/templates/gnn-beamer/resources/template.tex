\documentclass[$if(fontsize)$$fontsize$,$endif$$if(lang)$$babel-lang$,$endif$$if(handout)$handout,$endif$$if(colorlinks)$dvipsnames,$endif$$if(beamer)$ignorenonframetext,$endif$$for(classoption)$$classoption$$sep$,$endfor$]{$documentclass$}

\usepackage{xeCJK}
\usepackage{zxjatype}
\usepackage{mathtools}
\usepackage{amssymb,amsmath,xfrac}
\usepackage{unicode-math, xunicode}
\usepackage{fontawesome5}
\usepackage{textgreek}

% \usepackage[no-math]{fontspec}

\usepackage{bm}
\usefonttheme{professionalfonts}
%\setmathfont[Scale=0.86]{Asana-Math.otf}
% \setmathfont[Scale = 0.9]{XITSMath-Regular.otf}[BoldFont = {XITSMath-Bold.otf}]
% \setmainfont{NotoSerif-Regular.ttf}[ItalicFont     = {NotoSerif-Italic.ttf},
%                                     BoldFont       = {NotoSerif-Bold.ttf},
%                                     BoldItalicFont = {NotoSerif-BoldItalic.ttf}]
% \setsansfont{NotoSans-Regular.ttf}[ItalicFont     = {NotoSans-Italic.ttf},
%                                    BoldFont       = {NotoSans-Bold.ttf},
%                                    BoldItalicFont = {NotoSans-BoldItalic.ttf}]
% \defaultfontfeatures{Ligatures=TeX, Scale=MatchLowercase, Mapping=tex-text}

% \XeTeXlinebreaklocale "ja"
% \xeCJKsetup{CJKmath=true}
%\setCJKmainfont{Noto Serif CJK JP}
% \setCJKmainfont{Noto Sans CJK JP}
% \setCJKsansfont{Noto Sans CJK JP}
% \setCJKmonofont{Noto Sans Mono CJK JP}

\defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}

\setmainfont[Path=/usr/share/fonts/Noto/]{NotoSerif-Regular.ttf}[ItalicFont = NotoSerif-Italic.ttf,
  BoldFont = NotoSerif-Bold.ttf,
  BoldItalicFont = Notoserif-BoldItalic.ttf]
\setsansfont[Path=/usr/share/fonts/Noto/]{NotoSans-Regular.ttf}[ItalicFont = NotoSans-Italic.ttf,
  BoldFont = NotoSans-Bold.ttf,
  BoldItalicFont = NotoSans-BoldItalic.ttf]
\setmonofont[Mapping=tex-ansi]{Source Code Pro}
\setmathfont{XITS Math}
\setCJKmainfont[AutoFakeBold=true]{Noto Serif CJK JP}
\setCJKsansfont[AutoFakeBold=true]{Noto Sans CJK JP}
\setCJKmonofont[AutoFakeBold=true]{Noto Sans Mono CJK JP}

% To make handouts or not.
$if(handout)$
\makeatletter
\defbeamertemplate{note page}{plain2}{
  \vskip 2.0em
  \nointerlineskip
  \begin{minipage}{\linewidth} % this is an addition
  \setlength{\parskip}{0.8em}
  \insertnote
  \end{minipage}               % this is an addition
}
\makeatother
\setbeameroption{show notes}
\setbeamertemplate{note page}[plain2]
\setbeamerfont{note page}{size=\footnotesize}
\addtobeamertemplate{note page}{\setbeamerfont{itemize/enumerate subbody}{size=\footnotesize}}{}

\makeatletter
\def\beamer@setupnote{%
  \gdef\beamer@notesactions{%
    \beamer@outsideframenote{%
      \beamer@atbeginnote%
      \beamer@notes%
      \ifx\beamer@noteitems\@empty\else
      \begin{itemize}\itemsep=0pt\parskip=0pt%
        \beamer@noteitems%
      \end{itemize}%
      \fi%
      \beamer@atendnote%
    }%
    \gdef\beamer@notesactions{}%
  }
% Space between paragraphs on notes page
% \addtobeamertemplate{note page}{\setlength{\parskip}{12pt}}
}
\makeatother
$else$
\setbeameroption{hide notes}
\setbeamertemplate{note page}[plain]
$endif$

%%%%%%%%%%%%%%%%%%%%%%


\usepackage{upquote}
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts


\hypersetup{
  $if(title-meta)$
    pdftitle={$title-meta$},
  $endif$
  $if(author-meta)$
    pdfauthor={$author-meta$},
  $endif$
  $if(keywords)$
    pdfkeywords={$for(keywords)$$keywords$$sep$, $endfor$},
  $endif$
  $if(colorlinks)$
    colorlinks=true,
    linkcolor=$if(linkcolor)$$linkcolor$$else$grey$endif$,
    citecolor=$if(citecolor)$$citecolor$$else$grey$endif$,
    urlcolor=$if(urlcolor)$$urlcolor$$else$darkgrey$endif$,
  $else$
    pdfborder={0 0 0},
  $endif$
    breaklinks=true%
}%
$if(verbatim-in-note)$
  \VerbatimFootnotes % allows verbatim text in footnotes
$endif$
$if(listings)$
  \usepackage{listings}
$endif$
$if(lhs)$
  \lstnewenvironment{code}{\lstset{language=Haskell,basicstyle=\small\ttfamily}}{}
$endif$
$if(highlighting-macros)$
  $highlighting-macros$
$endif$
$if(tables)$
  \usepackage{longtable,booktabs}
  \usepackage{caption}
  % These lines are needed to make table captions work with longtable:
  \makeatletter
  \def\fnum@table{\tablename~\thetable}
  \makeatother
$endif$
$if(graphics)$
  \usepackage{graphicx,grffile}
  \makeatletter
  \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
  \def\maxheight{\ifdim\Gin@nat@height>\textheight0.8\textheight\else\Gin@nat@height\fi}
  \makeatother
  % Scale images if necessary, so that they will not overflow the page
  % margins by default, and it is still possible to overwrite the defaults
  % using explicit options in \includegraphics[width, height, ...]{}
  \setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
$endif$

%	Beamer colors to use.
\definecolor{nagasakiBlue}{HTML}{006fc5} % \nagasaki university school color DIC183
\definecolor{orange}{rgb}   {0.90,0.60,0.00}
\definecolor{skyblue}{rgb}  {0.35,0.70,0.90}
\definecolor{bluegreen}{rgb}{0.00,0.60,0.50}
\definecolor{yellow}{rgb}   {0.95,0.90,0.25}
\definecolor{blue}{rgb}     {0.00,0.45,0.70}
\definecolor{red}{rgb}      {0.80,0.40,0.00}
\definecolor{purple}{rgb}   {0.80,0.60,0.70}
\definecolor{gray}{rgb}     {0.8,0.8,0.8}
\definecolor{grey}{rgb}     {0.8,0.8,0.8}
\definecolor{darkgray}{rgb} {0.2,0.2,0.2}
\definecolor{darkgrey}{rgb} {0.2,0.2,0.2}
\definecolor{white}{rgb}{1,1,1}
% Prevent slide breaks in the middle of a paragraph:
\widowpenalties 1 10000
\raggedbottom

$if(section-titles)$
\AtBeginPart{
  \let\insertpartnumber\relax
  \let\partname\relax
  \frame{\partpage}
}
\AtBeginSection{
  \ifbibliography
  \else
    \let\insertsectionnumber\relax
    \let\sectionname\relax
    \frame{\sectionpage}
  \fi
}
\AtBeginSubsection{
  \let\insertsubsectionnumber\relax
  \let\subsectionname\relax
  \frame{\subsectionpage}
}
$endif$

$if(links-as-notes)$
  % Make links footnotes instead of hotlinks:
  \renewcommand{\href}[2]{#2\footnote{\url{#1}}}
$endif$
$if(strikeout)$
  \usepackage[normalem]{ulem}
  % avoid problems with \sout in headers with hyperref:
  \pdfstringdefDisableCommands{\renewcommand{\sout}{}}
$endif$
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
$if(numbersections)$
  \setcounter{secnumdepth}{$if(secnumdepth)$$secnumdepth$$else$5$endif$}
$else$
  \setcounter{secnumdepth}{0}
$endif$
$if(dir)$
  \ifxetex
    % load bidi as late as possible as it modifies e.g. graphicx
    $if(latex-dir-rtl)$
    \usepackage[RTLdocument]{bidi}
    $else$
    \usepackage{bidi}
    $endif$
  \fi
  \ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
    \TeXXeTstate=1
    \newcommand{\RL}[1]{\beginR #1\endR}
    \newcommand{\LR}[1]{\beginL #1\endL}
    \newenvironment{RTL}{\beginR}{\endR}
    \newenvironment{LTR}{\beginL}{\endL}
  \fi
$endif$

% header-includes will go here.
$for(header-includes)$
  $header-includes$
$endfor$

% Title, author, institute information
$if(title)$
  \title[$shorttitle$]{$title$}
$endif$
$if(subtitle)$
  \subtitle{$subtitle$}
$endif$
$if(author)$
  \author[
  $if(short-author)$
    $for(short-author)$$short-author$$sep$ \and $endfor$
  $else$
    $for(author)$$author$$sep$ \and $endfor$
  $endif$
  ]{$for(author)$$author$$sep$ \and $endfor$}
$endif$
$if(institute)$
  \institute[
  $if(short-institute)$
    $for(short-institute)$$short-institute$$sep$ \and $endfor$
  $endif$
  ]{
  $if(department)$
    $for(department)$$department$$sep$ \and $endfor$ \\
  $endif$
    $for(institute)$$institute$$sep$ \and $endfor$
  $if(email)$
  \\ $for(email)$ \href{mailto:$email$}{\nolinkurl{$email$}}$sep$ \and $endfor$
  $endif$
  }
$endif$
\date[
  $if(short-date)$
    $short-date$
  $else$
  $date$
  $endif$]{
    $if(date)$
    $date$
    $if(license)$
    \\ \vspace{5mm}
    $endif$
    $endif$
    $if(license)$
    {\scriptsize $license$}
    $endif$
  }

% Added packages.
\usepackage{
booktabs,
graphicx,
multicol,
pgfplots,
ragged2e,
tabularx,
tikz,
wasysym,
hyperref,
hanging,
multirow,
layout,
}
\usepackage[absolute, overlay, showboxes]{textpos}

% TIKZ packages
\usetikzlibrary{matrix, tikzmark, fit, shapes,}
\usetikzlibrary{arrows, positioning}
\usetikzlibrary{calc, intersections,through}
\usetikzlibrary{decorations.text, decorations.markings}


\usepackage[export]{adjustbox}

% Set Beamer templates
\setbeamertemplate{caption}[numbered]
\setbeamertemplate{caption label separator}{: }
\setbeamercolor{caption name}{fg=normal text.fg}

% \beamertemplatenavigationsymbols$if(navigation)$$navigation$$else$empty$endif$
\setbeamertemplate{navigation symbols}{}

% For the outer theme of the frame
\useoutertheme[subsection=false]{miniframes}

% For the table of content
\setbeamertemplate{section in toc}[sections numbered]
\setbeamertemplate{subsection in toc}[subsections numbered]

% Itemization
% This requires unicode-math!
\setbeamertemplate{itemize item}{\raise1.0pt\hbox{\tiny\faCircle}}
\setbeamertemplate{itemize subitem}{\raise1.0pt\hbox{\tiny\faDotCircle[regular]}}
\setbeamertemplate{itemize subsubitem}{\hbox{\tiny\faSquare}}

\setlength{\parskip}{0.5em}

% General
\setbeamercolor{normal text}{fg=darkgray}
% \hypersetup{colorlinks=true, urlcolor=blue, linkcolor=bluegreen, citecolor=blue}

\setbeamercolor{structure}{fg=darkgrey} % Basic color of text other than normal text.
\setbeamercolor{alerted text}{fg=red}
\setbeamercolor{example text}{fg=white}
\setbeamercolor{copyright text}{fg=skyblue}

% These colors are for the headline and footline.
\setbeamercolor{palette primary}{fg=white, bg =nagasakiBlue}
\setbeamercolor{palette secondary}{fg=darkgray,bg=nagasakiBlue}
\setbeamercolor{palette tertiary}{fg=red,bg=nagasakiBlue}
\setbeamercolor{palette quaternary}{fg=white,bg=nagasakiBlue}
% Footline and headline
\setbeamercolor{author in head/foot}{fg=white}
\setbeamercolor{title in head/foot}{fg=white}
\setbeamercolor{date in head/foot}{fg=white}
\setbeamercolor{shortinstitute in head/foot}{fg=white}
\setbeamercolor{page number in head/foot}{fg=white}
\setbeamercolor{section in head/foot}{fg=white, bg=nagasakiBlue}

\setbeamercolor{mini frame}{bg=nagasakiBlue}

% Titlepage
\setbeamercolor{title}{parent=normal text}
\setbeamercolor{subtitle}{parent=normal text}
\setbeamercolor{institute}{parent=normal text}

% Content
\setbeamercolor{frametitle}{fg=white, bg=nagasakiBlue}

% Blocks
\setbeamercolor{block title}{fg=white,bg=blue}
\setbeamercolor{block title example}{fg=white, bg=bluegreen}
\setbeamercolor{block title alerted}{fg=white, bg=red}
\setbeamercolor{block body}{fg=white, bg=skyblue}
\setbeamercolor{block body example}{fg=white, bg=skyblue}
\setbeamercolor{block body alerted}{fg=white, bg=skyblue}

% Notes
\setbeamercolor{note page}{fg=black,bg=white}
\setbeamercolor{note title}{fg=black, bg=white}
\setbeamercolor{note date}{parent=note title}

\setbeamercolor{qed}{fg=black}
\setbeamercolor{itemize item}{fg=nagasakiBlue}
\setbeamercolor{itemize subitem}{fg=purple}
\setbeamercolor{itemize subsubitem}{fg=skyblue}

% ------------------------------------------------------------------------------------------------
%	FONTS
% ------------------------------------------------------------------------------------------------

% ------------------------------------------------------------------------------------------------
%	FONT ASSIGMENTS
% ------------------------------------------------------------------------------------------------
% Title Page
%\newfontfamily\Light{Roboto Light}
\setbeamerfont{title}{size=\LARGE, series=\bfseries}
\setbeamerfont{subtitle}{size=\small, shape=\normalfont}
\setbeamerfont{date}{size=\footnotesize}
\setbeamerfont{author}{size=\small, series=\bfseries}
\setbeamerfont{institute}{size=\scriptsize}

% Section
\setbeamerfont{section title}{size=\Huge, series=\bfseries}

% Content
\setbeamerfont{frametitle}{size=\Large, series=\bfseries}
\setbeamerfont{copyright text}{size=\tiny}
\setbeamerfont{block title}{size=\large, series=\bfseries}
\setbeamerfont{block title alerted}{size=\large, series=\bfseries}
\setbeamerfont{block title example}{size=\large, series=\bfseries}

\setbeamerfont{caption}{size=\small}
\setbeamerfont{caption name}{family=\small}

% ------------------------------------------------------------------------------------------------
%	TITLE PAGE
% ------------------------------------------------------------------------------------------------

\newcommand\AtPageUpperRight[1]{\AtPageUpperLeft{%
 \put(\LenToUnit{\paperwidth},\LenToUnit{0\paperheight}){#1}%
 }}%
\newcommand\AtPageLowerRight[1]{\AtPageLowerLeft{%
 \put(\LenToUnit{\paperwidth},\LenToUnit{0\paperheight}){#1}%
 }}%

\pgfdeclareimage[width=0.35\paperwidth]{titlelogo}{logo/ape_background.pdf}

% Structure of the titlepage
\def\maketitle{\ifbeamer@inframe\titlepage\else\frame[plain]{\titlepage}\fi}
\def\titlepage{\usebeamertemplate{title page}}
\setbeamertemplate{title page} {


  $if(logo)$
	\begin{tikzpicture}[remember picture, overlay]
	  \node[xshift = 4cm, yshift = -1cm] at (current page.center) {\pgfuseimage{titlelogo}};
	\end{tikzpicture}
  $endif$

	\begin{minipage}[b][\paperheight]{\textwidth}
  \raggedright
	\vspace*{20mm}
	\ifx\insertsubtitle\@empty%
	\else%
		{\usebeamerfont{title}\usebeamercolor[fg]{title}\inserttitle\parskip0pt\par}%
		\vspace*{3mm}
	\fi%
	\ifx\insertsubtitle\@empty%
	\else%
		{\usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par}%
		\vspace*{5mm}
	\fi%
	\ifx\insertdate\@empty%
	\else%
		{\usebeamerfont{date}\usebeamercolor[fg]{date}\insertdate\par}%
	\fi%

	\vfill

	\ifx\insertauthor\@empty%
	\else%
		{\usebeamerfont{author}\usebeamercolor[fg]{author}\insertauthor\par}%
	\fi%
	\ifx\insertinstitut\@empty%
	\else%
		\vspace*{1mm}
		{\usebeamerfont{institute}\usebeamercolor[nagasakiBlue]{institute}\insertinstitute\par}%
	\fi%
	\vspace*{5mm}

	\end{minipage}
}

% ------------------------------------------------------------------------------------------------
%	SECTION PAGES
% ------------------------------------------------------------------------------------------------

% Make Sectionhead uppercase
\newcommand{\insertsectionHEAD}{%
	\expandafter\insertsectionHEADaux\insertsectionhead}
	\newcommand{\insertsectionHEADaux}[3]{#3}

\if@doSectionPage\@empty
\else
% Insert frame with section title at every section start
\AtBeginSection[]
{
\begingroup
\setbeamercolor{background canvas}{bg=nagasakiBlue}
\begin{frame}[plain]
\centering
\vfill\usebeamerfont{section title}\textcolor{white}{\insertsectionHEAD}\vfill
\end{frame}
\endgroup
}
\fi

% ------------------------------------------------------------------------------------------------
%	HEADLINE
% ------------------------------------------------------------------------------------------------
\setbeamertemplate{headline}{} % Remove header navigation bar
\setbeamertemplate{navigation symbols}{}
\makeatletter
% \def\progressbar@progressbar{} % the progress bar
% \newcount\progressbar@tmpcounta% auxiliary counter
% \newcount\progressbar@tmpcountb% auxiliary counter
% \newdimen\progressbar@pbht %progressbar height
% \newdimen\progressbar@pbwd %progressbar width
% \newdimen\progressbar@tmpdim % auxiliary dimension
%
% \progressbar@pbwd=\paperwidth
% \progressbar@pbht=1.25ex
%
% % the progress bar
% \def\progressbar@progressbar{%
%   \progressbar@tmpcounta=\insertframenumber
%   \progressbar@tmpcountb=\inserttotalframenumber
%   \progressbar@tmpdim=\progressbar@pbwd
%   \divide\progressbar@tmpdim by 100
%   \multiply\progressbar@tmpdim by \progressbar@tmpcounta
%   \divide\progressbar@tmpdim by \progressbar@tmpcountb
%   \multiply\progressbar@tmpdim by 100
%
%   \begin{tikzpicture}[very thin]
%     \draw[fill=nagasakiBlue] (0pt, 0pt) rectangle ++ (\progressbar@pbwd, \progressbar@pbht);
%     \draw[fill=darkgrey] (0pt, 0pt) rectangle ++ (\progressbar@tmpdim, \progressbar@pbht);
%   \end{tikzpicture}%
% }

\addtobeamertemplate{headline} {
  %\begin{beamercolorbox}[wd=\paperwidth,ht=1ex,center,dp=0ex]{nagasakiBlue}% Original when progress bar was ok.
  \begin{beamercolorbox}[wd=\paperwidth,ht=0ex,center,dp=0ex]{nagasakiBlue}%
    % \progressbar@progressbar% The progresss bar was giving errors during compile so I removed it.
  \end{beamercolorbox}%
}
\makeatother

\setbeamertemplate{frametitle} {
\ifbeamercolorempty[bg]{frametitle}{}{\nointerlineskip}%
\begin{beamercolorbox}[sep=0ex,wd=\paperwidth,leftskip=0.25cm,rightskip=0pt plus 4em, ht=2.25ex, dp=1.0ex]{frametitle}
	 \usebeamerfont*{frametitle}{\insertframetitle}%
\end{beamercolorbox}
}
% ------------------------------------------------------------------------------------------------
%	FOOTLINE
% ------------------------------------------------------------------------------------------------
\usenavigationsymbolstemplate{}
\setbeamertemplate{footline} {
  \leavevmode%
  \hbox{%
  \begin{beamercolorbox}[sep=0.5ex,wd=0.7\paperwidth,ht=3.25ex,dp=1.250ex,leftskip=0.25cm, rightskip=0pt plus 4em]{title in head/foot}%
    \usebeamerfont{title in head/foot}\hypersetup{hidelinks}\insertshorttitle{}
  \end{beamercolorbox}%
  \begin{beamercolorbox}[sep=0.5ex,wd=.3\paperwidth,ht=3.25ex,dp=1.25ex,right]{date in head/foot}%
    \usebeamerfont{date in head/foot}\insertframenumber{} / \inserttotalframenumber \hspace*{2ex}%
  \end{beamercolorbox}}%
  \vskip0pt%
}

% ------------------------------------------------------------------------------------------------
%	CAPTIONS
% ------------------------------------------------------------------------------------------------
\setbeamertemplate{caption label separator}{. }

% ------------------------------------------------------------------------------------------------
%	BLOCKS
% ------------------------------------------------------------------------------------------------
\setbeamertemplate{block begin}
{
  \setbeamercolor{item}{parent=block body}
  \par\vskip\medskipamount%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex]{block title}
    \usebeamerfont*{block title}\insertblocktitle%
  \end{beamercolorbox}%
  {\parskip0pt\par}%
  {\nointerlineskip\vskip-0.5pt}%
  \usebeamerfont{block body}%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex,vmode]{block body}%
}
\setbeamertemplate{block end}
{\end{beamercolorbox}\vskip\smallskipamount}

\setbeamertemplate{block alerted begin}
{
  \setbeamercolor{item}{parent=block body alerted}
  \par\vskip\medskipamount%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex]{block title alerted}
    \usebeamerfont*{block title alerted}\insertblocktitle%
  \end{beamercolorbox}%
  {\parskip0pt\par}%
  {\nointerlineskip\vskip-0.5pt}%
  \usebeamerfont{block body alerted}%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex,vmode]{block body alerted}%
}
\setbeamertemplate{block alerted end}
{\end{beamercolorbox}\vskip\smallskipamount}

\setbeamertemplate{block example begin}
{
  \par\vskip\medskipamount%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex]{block title example}
    \usebeamerfont*{block title example}\insertblocktitle%
  \end{beamercolorbox}%
  {\parskip0pt\par}%
  {\nointerlineskip\vskip-0.5pt}%
  \usebeamerfont{block body example}%
  \begin{beamercolorbox}[sep=.5ex,dp=0.6ex,leftskip=0.5ex,rightskip=0.5ex,vmode]{block body example}%
}
\setbeamertemplate{block example end}
{\end{beamercolorbox}\vskip\smallskipamount}

% ------------------------------------------------------------------------------------------------
%	BLOCK HOVERING ABOVE THE SLIDE
% ------------------------------------------------------------------------------------------------

\newcommand<>{\hover}[1]{\uncover#2{%
	\begin{tikzpicture}[remember picture,overlay]%
	\draw[fill,opacity=0.4] (current page.south west)
	rectangle (current page.north east);
	\node at (current page.center) {#1};
	\end{tikzpicture}}
	}

% ------------------------------------------------------------------------------------------------
%	VERTICALLY ALIGNED COLUMNS
% ------------------------------------------------------------------------------------------------

\usepackage{environ}% Required for \NewEnviron, i.e. to read the whole body of the environment

\newcounter{acolumn}%  Number of current column
\newlength{\acolumnmaxheight}%   Maximum column height


% `column` replacement to measure height
\newenvironment{@acolumn}[1]{%
    \stepcounter{acolumn}%
    \begin{lrbox}{\@tempboxa}%
    \begin{minipage}{#1}%
}{%
    \end{minipage}
    \end{lrbox}
    \@tempdimc=\dimexpr\ht\@tempboxa+\dp\@tempboxa\relax
    % Save height of this column:
    \expandafter\xdef\csname acolumn@height@\roman{acolumn}\endcsname{\the\@tempdimc}%
    % Save maximum height
    \ifdim\@tempdimc>\acolumnmaxheight
        \global\acolumnmaxheight=\@tempdimc
    \fi
}

% `column` wrapper which sets the height beforehand
\newenvironment{@@acolumn}[1]{%
    \stepcounter{acolumn}%
    % The \autoheight macro contains a \vspace macro with the maximum height minus the natural column height
    \edef\autoheight{\noexpand\vspace*{\dimexpr\acolumnmaxheight-\csname acolumn@height@\roman{acolumn}\endcsname\relax}}%
    % Call original `column`:
    \orig@column{#1}%
}{%
    \endorig@column
}

% Save orignal `column` environment away
\let\orig@column\column
\let\endorig@column\endcolumn

% `columns` variant with automatic height adjustment
\NewEnviron{acolumns}[1][]{%
    % Init vars:
    \setcounter{acolumn}{0}%
    \setlength{\acolumnmaxheight}{0pt}%
    \def\autoheight{\vspace*{0pt}}%
    % Set `column` environment to special measuring environment
    \let\column\@acolumn
    \let\endcolumn\end@acolumn
    \BODY% measure heights
    % Reset counter for second processing round
    \setcounter{acolumn}{0}%
    % Set `column` environment to wrapper
    \let\column\@@acolumn
    \let\endcolumn\end@@acolumn
    % Finally process columns now for real
    \begin{columns}[#1]%
        \BODY
    \end{columns}%
}

% Redefining some environments to make it easy to write code.
% Easy two-column layout that allows markdown.
\def\begincols{\begin{columns}}
\def\begincol{\begin{column}}
\def\endcol{\end{column}}
\def\endcols{\end{columns}}


%	IMAGES
% ------------------------------------------------------------------------------------------------

\newbox\mytempbox
\newdimen\mytempdimen

\newcommand\includegraphicscopyright[3][]{%
  \leavevmode\vbox{\vskip3pt\raggedright\setbox\mytempbox=\hbox{\includegraphics[#1]{#2}}%
    \mytempdimen=\wd\mytempbox\box\mytempbox\par\vskip1pt%
    \usebeamerfont{copyright text}{\usebeamercolor[fg]{copyright text}{\vbox{\hsize=\mytempdimen#3}}}\vskip3pt%
}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document begins here
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
% Hide progress bar and footline on titlepage
$if(title)$
\begin{frame}[plain]
\titlepage
\end{frame}
$endif$

$for(include-before)$
$include-before$

$endfor$
$if(toc)$
\begin{frame}
\tableofcontents[hideallsubsections]
\end{frame}

$endif$
$body$

$if(natbib)$
$if(bibliography)$
$if(biblio-title)$
$if(book-class)$
\renewcommand\bibname{$biblio-title$}
$else$
\renewcommand\refname{$biblio-title$}
$endif$
$endif$
\begin{frame}[allowframebreaks]{$biblio-title$}
\bibliographytrue
\bibliography{$for(bibliography)$$bibliography$$sep$,$endfor$}
\end{frame}

$endif$
$endif$
$if(biblatex)$
\begin{frame}[allowframebreaks]{$biblio-title$}
\bibliographytrue
\printbibliography[heading=none]
\end{frame}

$endif$
$for(include-after)$
$include-after$

$endfor$
\end{document}